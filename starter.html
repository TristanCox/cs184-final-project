<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { margin: 0; }
        canvas { display: block; }
    </style>
    <script src="./two.js"></script>
</head>
<body>
    <div id="draw-shapes"></div>
    <script>
        var MAX_16BIT_SIGNED = 32767;
        function getKey(x, y) {
          if (x > MAX_16BIT_SIGNED || y > MAX_16BIT_SIGNED)
            throw "Invalid X or Y value.";
          x += MAX_16BIT_SIGNED;
          y += MAX_16BIT_SIGNED;
          return (x << 16) | y;
        }
        var width = 400;
        var height = 300;
        var center_x = 213;
        var center_y = 100;
        var the_calm_downer = 10;
        var elem = document.getElementById('draw-shapes');
        var params = { width: width, height: height };
        var two = new Two(params).appendTo(elem);
        var stepLength = 12;
        var magnets = new Array(2);
        for (var i = 0; i < magnets.length; i++) {
          magnets[i] = new Array(3);
        }
        magnets[0] = [center_x, center_y, 50];
        magnets[1] = [150, 150, 50];
        var vectors = {};
        console.log(magnets);
        var d = new Date();
        var t = d.getTime();
        console.log(t);
        for (var i = 0; i < width; i+= stepLength) {
            for (var j = 0; j < height; j+=stepLength) {
              var str = getKey(i, j);
              var currVect = vectors[str];
              for (var k = 0; k < magnets.length; k++) {
                var br = new Two.Vector((i - magnets[k][0])/the_calm_downer, (j - magnets[k][1])/the_calm_downer);
                var r = br.length();
                //if (r > magnets[k][2] / 5){
                  //continue;
                //}
                var rhat = new Two.Vector(br.x,br.y);
                rhat.set(rhat.x / r, rhat.y / r);
                var m = new Two.Vector(0, 5*20 / 6 * magnets[k][2]);
                var numTermOne = 3 * rhat.dot(m);
                var numerator = (rhat.multiplyScalar(numTermOne)).subSelf(m);
                numerator.divideScalar(2 * Math.PI * r * r);


                //if(r > 1.5) {
                    if (currVect == null) {
                      vectors[str] = new Two.Vector();
                    } 
                    vectors[str].addSelf(numerator);
                    currVect = vectors[str];
                //}
              }
              //if (currVect == null)
                //continue;
              if (currVect.length() > stepLength * 2)
                currVect = currVect.normalize().multiplyScalar(stepLength * 2);
              var x2 = i + 0.5 * (currVect.x);
              var x1 = i - 0.5 * (currVect.x);
              var y2 = j + 0.5 * (currVect.y);
              var y1 = j - 0.5 * (currVect.y);

              var line = two.makeLine(x1, y1, x2, y2);
              line.linewidth = 0.5;
              line.fill = "#881111";
              line.stroke = "rgba(0, 0, 0, 255)";
              var begin = Date.now()
              while (Date.now() - begin < 1000) {
                continue;
              }
            }
        }
        // two has convenience methods to create shapes.
        var rect = two.makeRectangle(213, 100, 10, 20);

        rect.fill = 'rgb(0, 200, 255)';
        rect.noStroke();

        var rect2 = two.makeRectangle(150, 150, 10, 20);

        rect2.fill = 'blue';
        rect2.noStroke();

        // Don't forget to tell two to render everything
        // to the screen
        two.update();
        d = new Date();
        console.log(d.getTime(), t);
        console.log(1000.0 / (d.getTime() - t));
    </script>
</body>
</html>
